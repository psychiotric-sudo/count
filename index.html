<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invoice Generator</title>
    <meta
      name="description"
      content="Offline invoice generator for PDF and DOCX printing jobs." />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet" />

    <style>
      :root {
        --white: #ffffff;
        --gray-50: #fafafa;
        --gray-100: #f5f5f5;
        --gray-200: #e5e5e5;
        --gray-300: #d4d4d4;
        --gray-400: #a3a3a3;
        --gray-500: #737373;
        --gray-600: #525252;
        --gray-700: #404040;
        --gray-800: #262626;
        --gray-900: #171717;
        --primary: #0a0a0a;
        --primary-light: #262626;
        --accent: #2563eb;
        --accent-light: #3b82f6;
        --danger: #dc2626;
        --danger-light: #ef4444;
        --success: #16a34a;
        --warning: #f59e0b;
        --info: #0ea5e9;
        --radius-sm: 6px;
        --radius: 10px;
        --radius-lg: 14px;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-md:
          0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg:
          0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --transition: 150ms ease;

        /* Color coding for table rows */
        --row-low: #f0fdf4;
        --row-low-border: #bbf7d0;
        --row-medium: #fefce8;
        --row-medium-border: #fef08a;
        --row-high: #fff7ed;
        --row-high-border: #fed7aa;
        --row-very-high: #fef2f2;
        --row-very-high-border: #fecaca;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        font-size: 15px;
      }

      body {
        font-family:
          "Outfit",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          sans-serif;
        background: var(--gray-50);
        color: var(--gray-900);
        line-height: 1.5;
        min-height: 100vh;
      }

      /* Layout */
      .app {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px 16px 80px;
      }

      @media (min-width: 768px) {
        .app {
          padding: 32px 24px 80px;
        }
      }

      .header {
        margin-bottom: 24px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
      }

      .header-left {
        flex: 1;
        min-width: 200px;
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: -0.025em;
        color: var(--gray-900);
        margin-bottom: 4px;
      }

      @media (min-width: 768px) {
        .header h1 {
          font-size: 1.75rem;
        }
      }

      .header p {
        font-size: 0.85rem;
        color: var(--gray-500);
        font-weight: 400;
      }

      .header-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        padding: 6px 12px;
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: 999px;
        font-size: 0.75rem;
        color: var(--gray-600);
      }

      .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--success);
      }

      .status-dot.offline {
        background: var(--gray-400);
      }

      /* Main Grid */
      .main-grid {
        display: grid;
        gap: 24px;
      }

      @media (min-width: 1024px) {
        .main-grid {
          grid-template-columns: 1fr 400px;
          gap: 32px;
        }
      }

      @media (min-width: 1280px) {
        .main-grid {
          grid-template-columns: 1fr 420px;
        }
      }

      /* Sections */
      .section {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        overflow: hidden;
      }

      .section-header {
        padding: 14px 16px;
        border-bottom: 1px solid var(--gray-100);
        background: var(--gray-50);
      }

      @media (min-width: 768px) {
        .section-header {
          padding: 16px 20px;
        }
      }

      .section-header h2 {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--gray-700);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .section-body {
        padding: 16px;
      }

      @media (min-width: 768px) {
        .section-body {
          padding: 20px;
        }
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 16px;
        font-family: inherit;
        font-size: 0.85rem;
        font-weight: 500;
        border-radius: var(--radius);
        border: 1px solid var(--gray-200);
        background: var(--white);
        color: var(--gray-700);
        cursor: pointer;
        transition: all var(--transition);
        white-space: nowrap;
      }

      .btn:hover {
        background: var(--gray-50);
        border-color: var(--gray-300);
      }

      .btn:active {
        transform: scale(0.98);
      }

      .btn-primary {
        background: var(--primary);
        border-color: var(--primary);
        color: var(--white);
      }

      .btn-primary:hover {
        background: var(--primary-light);
        border-color: var(--primary-light);
      }

      .btn-danger {
        color: var(--danger);
        border-color: var(--danger);
      }

      .btn-danger:hover {
        background: var(--danger);
        color: var(--white);
      }

      .btn-ghost {
        border-color: transparent;
        background: transparent;
      }

      .btn-ghost:hover {
        background: var(--gray-100);
        border-color: transparent;
      }

      .btn-sm {
        padding: 6px 10px;
        font-size: 0.8rem;
      }

      .btn-icon {
        padding: 8px;
        border-radius: var(--radius);
      }

      .btn-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      /* Forms */
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .form-label {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--gray-600);
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 10px 12px;
        font-family: inherit;
        font-size: 0.9rem;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius);
        background: var(--white);
        color: var(--gray-900);
        transition: all var(--transition);
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .form-input::placeholder,
      .form-textarea::placeholder {
        color: var(--gray-400);
      }

      .form-textarea {
        min-height: 80px;
        resize: vertical;
      }

      .form-grid {
        display: grid;
        gap: 16px;
      }

      .form-grid-2 {
        grid-template-columns: 1fr 1fr;
      }

      .form-grid-3 {
        grid-template-columns: repeat(3, 1fr);
      }

      @media (max-width: 600px) {
        .form-grid-2,
        .form-grid-3 {
          grid-template-columns: 1fr;
        }
      }

      .form-hint {
        font-size: 0.75rem;
        color: var(--gray-400);
        margin-top: 4px;
      }

      /* Toggle switch */
      .toggle-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--gray-100);
      }

      .toggle-row:last-child {
        border-bottom: none;
      }

      .toggle-label {
        font-size: 0.85rem;
        color: var(--gray-700);
      }

      .toggle-desc {
        font-size: 0.75rem;
        color: var(--gray-400);
        margin-top: 2px;
      }

      .toggle {
        position: relative;
        width: 44px;
        height: 24px;
        background: var(--gray-200);
        border-radius: 12px;
        cursor: pointer;
        transition: background var(--transition);
      }

      .toggle::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: var(--white);
        border-radius: 50%;
        box-shadow: var(--shadow-sm);
        transition: transform var(--transition);
      }

      .toggle.active {
        background: var(--accent);
      }

      .toggle.active::after {
        transform: translateX(20px);
      }

      /* Table */
      .table-wrapper {
        overflow-x: auto;
        margin: 0 -16px;
        padding: 0 16px;
      }

      @media (min-width: 768px) {
        .table-wrapper {
          margin: 0 -20px;
          padding: 0 20px;
        }
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }

      @media (min-width: 768px) {
        .table {
          font-size: 0.9rem;
        }
      }

      .table th {
        text-align: left;
        padding: 10px 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-500);
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-200);
      }

      @media (min-width: 768px) {
        .table th {
          padding: 12px 16px;
          font-size: 0.75rem;
        }
      }

      .table td {
        padding: 12px;
        border-bottom: 1px solid var(--gray-100);
        vertical-align: middle;
      }

      @media (min-width: 768px) {
        .table td {
          padding: 14px 16px;
        }
      }

      .table tr:last-child td {
        border-bottom: none;
      }

      .table tr:hover td {
        background: var(--gray-50);
      }

      /* Color coded rows */
      .table tr.row-low td {
        background: var(--row-low);
        border-bottom-color: var(--row-low-border);
      }

      .table tr.row-medium td {
        background: var(--row-medium);
        border-bottom-color: var(--row-medium-border);
      }

      .table tr.row-high td {
        background: var(--row-high);
        border-bottom-color: var(--row-high-border);
      }

      .table tr.row-very-high td {
        background: var(--row-very-high);
        border-bottom-color: var(--row-very-high-border);
      }

      .table .num {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      .table .num input {
        text-align: right;
      }

      .table input {
        width: 70px;
        padding: 6px 8px;
        font-size: 0.8rem;
      }

      @media (min-width: 768px) {
        .table input {
          width: 90px;
          padding: 8px 10px;
          font-size: 0.85rem;
        }
      }

      .doc-name {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .doc-name strong {
        font-weight: 500;
        color: var(--gray-900);
        word-break: break-word;
        font-size: 0.8rem;
      }

      @media (min-width: 768px) {
        .doc-name strong {
          font-size: 0.9rem;
        }
      }

      .doc-name span {
        font-size: 0.7rem;
        color: var(--gray-400);
      }

      .doc-total {
        font-weight: 600;
        color: var(--gray-900);
      }

      .empty-state {
        text-align: center;
        padding: 32px 16px;
        color: var(--gray-400);
      }

      @media (min-width: 768px) {
        .empty-state {
          padding: 48px 20px;
        }
      }

      .empty-state p {
        font-size: 0.85rem;
      }

      /* Invoice Preview */
      .preview-column {
        position: sticky;
        top: 24px;
        align-self: start;
      }

      @media (max-width: 1023px) {
        .preview-column {
          position: static;
        }
      }

      .invoice-preview {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-md);
      }

      .invoice-header {
        padding: 16px;
        background: linear-gradient(
          135deg,
          var(--gray-50) 0%,
          var(--white) 100%
        );
        border-bottom: 1px solid var(--gray-200);
      }

      @media (min-width: 768px) {
        .invoice-header {
          padding: 20px;
        }
      }

      .invoice-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 12px;
      }

      @media (min-width: 768px) {
        .invoice-title {
          font-size: 1.25rem;
          margin-bottom: 16px;
        }
      }

      .invoice-meta {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      @media (max-width: 500px) {
        .invoice-meta {
          grid-template-columns: 1fr;
        }
      }

      .meta-card {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius);
        padding: 10px;
      }

      @media (min-width: 768px) {
        .meta-card {
          padding: 12px;
        }
      }

      .meta-row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        padding: 4px 0;
        font-size: 0.8rem;
      }

      @media (min-width: 768px) {
        .meta-row {
          font-size: 0.85rem;
        }
      }

      .meta-row:not(:last-child) {
        border-bottom: 1px solid var(--gray-100);
      }

      .meta-label {
        color: var(--gray-500);
      }

      .meta-value {
        font-weight: 500;
        color: var(--gray-900);
        text-align: right;
        word-break: break-word;
        max-width: 60%;
      }

      .invoice-body {
        padding: 16px;
      }

      @media (min-width: 768px) {
        .invoice-body {
          padding: 20px;
        }
      }

      .invoice-table {
        margin-bottom: 16px;
      }

      .invoice-table .table th {
        background: var(--white);
        border-bottom: 2px solid var(--gray-900);
      }

      .invoice-table .table td {
        border-bottom: 1px solid var(--gray-100);
      }

      .invoice-summary {
        border-top: 2px solid var(--gray-200);
        padding-top: 16px;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        font-size: 0.85rem;
      }

      .summary-row .label {
        color: var(--gray-600);
      }

      .summary-row .value {
        font-weight: 500;
        font-variant-numeric: tabular-nums;
      }

      .summary-total {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 2px dashed var(--gray-300);
      }

      .summary-total .label {
        font-weight: 600;
        color: var(--gray-900);
      }

      .summary-total .value {
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--gray-900);
      }

      @media (min-width: 768px) {
        .summary-total .value {
          font-size: 1.25rem;
        }
      }

      /* Export Section */
      .export-section {
        margin-top: 16px;
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 16px;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 200ms ease,
          visibility 200ms ease;
      }

      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        width: 100%;
        max-width: 520px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transform: scale(0.95) translateY(10px);
        transition: transform 200ms ease;
      }

      .modal-overlay.active .modal {
        transform: scale(1) translateY(0);
      }

      .modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--gray-100);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h3 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-900);
      }

      .modal-close {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: transparent;
        border-radius: var(--radius-sm);
        cursor: pointer;
        color: var(--gray-400);
        transition: all var(--transition);
      }

      .modal-close:hover {
        background: var(--gray-100);
        color: var(--gray-600);
      }

      .modal-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
      }

      .modal-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--gray-100);
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }

      /* Analytics Cards */
      .analytics-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }

      @media (max-width: 500px) {
        .analytics-grid {
          grid-template-columns: 1fr;
        }
      }

      .stat-card {
        background: var(--gray-50);
        border: 1px solid var(--gray-100);
        border-radius: var(--radius);
        padding: 16px;
      }

      .stat-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: 6px;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
      }

      .stat-value.accent {
        color: var(--accent);
      }

      .stat-value.success {
        color: var(--success);
      }

      .analytics-list {
        margin-top: 16px;
      }

      .analytics-list-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--gray-600);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      .analytics-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid var(--gray-100);
        font-size: 0.85rem;
      }

      .analytics-list-item:last-child {
        border-bottom: none;
      }

      .analytics-list-item .name {
        color: var(--gray-700);
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .analytics-list-item .value {
        font-weight: 600;
        color: var(--gray-900);
        margin-left: 12px;
      }

      /* Toast */
      .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1100;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      @media (max-width: 500px) {
        .toast-container {
          left: 16px;
          right: 16px;
          bottom: 16px;
        }
      }

      .toast {
        background: var(--gray-900);
        color: var(--white);
        padding: 12px 16px;
        border-radius: var(--radius);
        box-shadow: var(--shadow-md);
        font-size: 0.85rem;
        max-width: 320px;
        animation: slideIn 200ms ease;
      }

      @media (max-width: 500px) {
        .toast {
          max-width: 100%;
        }
      }

      .toast strong {
        display: block;
        font-weight: 600;
        margin-bottom: 2px;
      }

      .toast span {
        color: var(--gray-300);
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* Flash animation */
      .flash {
        animation: flash 400ms ease;
      }

      @keyframes flash {
        0% {
          background-color: rgba(37, 99, 235, 0.1);
        }
        100% {
          background-color: transparent;
        }
      }

      /* Utilities */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .spacer {
        height: 16px;
      }

      .text-muted {
        color: var(--gray-500);
        font-size: 0.8rem;
      }

      /* Settings Tabs */
      .settings-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 16px;
        border-bottom: 1px solid var(--gray-100);
      }

      .settings-tab {
        padding: 10px 16px;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--gray-500);
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        transition: all var(--transition);
        margin-bottom: -1px;
      }

      .settings-tab:hover {
        color: var(--gray-700);
      }

      .settings-tab.active {
        color: var(--gray-900);
        border-bottom-color: var(--gray-900);
      }

      .settings-panel {
        display: none;
      }

      .settings-panel.active {
        display: block;
      }

      /* Tiered Pricing */
      .tier-row {
        display: grid;
        grid-template-columns: 1fr 60px 1fr 32px;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }

      .tier-row .tier-label {
        font-size: 0.75rem;
        color: var(--gray-500);
        text-align: center;
      }

      .tier-arrow {
        text-align: center;
        color: var(--gray-400);
      }

      .tier-discount-label {
        font-size: 0.75rem;
        color: var(--gray-500);
        text-align: center;
      }

      .tier-remove {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--gray-200);
        background: var(--white);
        border-radius: var(--radius-sm);
        cursor: pointer;
        color: var(--gray-400);
        transition: all var(--transition);
      }

      .tier-remove:hover {
        border-color: var(--danger);
        color: var(--danger);
        background: var(--row-very-high);
      }
    </style>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"
      defer></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
      defer></script>
    <script
      src="https://unpkg.com/mammoth/mammoth.browser.min.js"
      defer></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
      defer></script>
  </head>

  <body>
    <div class="app">
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <h1>Invoice Generator</h1>
          <p
            >Upload PDFs & DOCX files, calculate totals by page, and export your
            invoice.</p
          >
          <div class="status-badge">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Ready</span>
          </div>
        </div>
        <div class="header-actions">
          <button
            type="button"
            class="btn btn-icon"
            id="analyticsBtn"
            title="Analytics">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round">
              <line x1="18" y1="20" x2="18" y2="10" />
              <line x1="12" y1="20" x2="12" y2="4" />
              <line x1="6" y1="20" x2="6" y2="14" />
            </svg>
          </button>
          <button
            type="button"
            class="btn btn-icon"
            id="settingsBtn"
            title="Settings">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round">
              <circle cx="12" cy="12" r="3" />
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
            </svg>
          </button>
          <button
            type="button"
            class="btn btn-icon"
            id="ordersBtn"
            title="Orders"
            style="position: relative">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2">
              <path d="M3 3h18v4H3z" />
              <path d="M7 11v6a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-6" />
            </svg>
          </button>
        </div>
      </header>

      <!-- Main Content -->
      <div class="main-grid">
        <!-- Left Column: Editor -->
        <div class="editor-column">
          <!-- Upload Section -->
          <div class="section">
            <div class="section-header">
              <h2>Documents</h2>
            </div>
            <div class="section-body">
              <div class="btn-row" style="margin-bottom: 16px">
                <input
                  type="file"
                  id="fileInput"
                  class="sr-only"
                  multiple
                  accept="application/pdf,.docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
                <label
                  for="fileInput"
                  class="btn btn-primary"
                  id="uploadBtn"
                  style="cursor: pointer; margin: 0">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="17 8 12 3 7 8" />
                    <line x1="12" y1="3" x2="12" y2="15" />
                  </svg>
                  Upload Files
                </label>
                <button type="button" class="btn btn-danger" id="clearBtn"
                  >Clear All</button
                >
                <button type="button" class="btn btn-ghost" id="newInvoiceBtn"
                  >New Invoice</button
                >
                <button type="button" class="btn btn-ghost" id="recentDocsBtn"
                  >Recent Documents</button
                >
              </div>

              <div class="btn-row" style="margin-bottom: 16px">
                <div class="form-group" style="min-width: 140px">
                  <select id="sortSelect" class="form-select">
                    <option value="added">Sort: Added order</option>
                    <option value="pages_asc">Sort: Pages ↑</option>
                    <option value="pages_desc">Sort: Pages ↓</option>
                    <option value="total_asc">Sort: Total ↑</option>
                    <option value="total_desc">Sort: Total ↓</option>
                  </select>
                </div>
                <button type="button" class="btn" id="applyPriceAllBtn"
                  >Apply Price to All</button
                >
              </div>

              <div class="table-wrapper">
                <table class="table" id="docsTable">
                  <thead>
                    <tr>
                      <th>Document</th>
                      <th class="num">Pages</th>
                      <th class="num">Price/Page</th>
                      <th class="num">Total</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="tbody">
                    <tr class="empty-row">
                      <td colspan="5">
                        <div class="empty-state">
                          <p
                            >No documents yet. Upload PDF or DOCX files to get
                            started.</p
                          >
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="spacer"></div>

          <!-- Invoice Details -->
          <div class="section">
            <div class="section-header">
              <h2>Invoice Details</h2>
            </div>
            <div class="section-body">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label" for="clientName">Client Name</label>
                  <input
                    type="text"
                    id="clientName"
                    class="form-input"
                    placeholder="Enter client name"
                    list="clientHistory" />
                  <datalist id="clientHistory"></datalist>
                </div>
                <div class="form-grid form-grid-2">
                  <div class="form-group">
                    <label class="form-label" for="invoiceDate">Date</label>
                    <input type="date" id="invoiceDate" class="form-input" />
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="invoiceNumber"
                      >Invoice #</label
                    >
                    <input
                      type="text"
                      id="invoiceNumber"
                      class="form-input"
                      placeholder="Auto-generated"
                      readonly />
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label" for="remarks"
                    >Remarks / Notes</label
                  >
                  <textarea
                    id="remarks"
                    class="form-textarea"
                    placeholder="Additional notes or instructions"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Preview & Export -->
        <div class="preview-column">
          <!-- Invoice Preview -->
          <div class="invoice-preview" id="invoiceArea">
            <div class="invoice-header">
              <div class="invoice-title">INVOICE</div>
              <div class="invoice-meta">
                <div class="meta-card">
                  <div class="meta-row">
                    <span class="meta-label">Client</span>
                    <span class="meta-value" id="pvClient">—</span>
                  </div>
                  <div class="meta-row">
                    <span class="meta-label">Remarks</span>
                    <span class="meta-value" id="pvRemarks">—</span>
                  </div>
                </div>
                <div class="meta-card">
                  <div class="meta-row">
                    <span class="meta-label">Date</span>
                    <span class="meta-value" id="pvDate">—</span>
                  </div>
                  <div class="meta-row">
                    <span class="meta-label">Invoice #</span>
                    <span class="meta-value" id="pvInv">—</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="invoice-body">
              <div class="invoice-table">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th class="num">Pages</th>
                      <th class="num">Price</th>
                      <th class="num">Total</th>
                    </tr>
                  </thead>
                  <tbody id="pvTable"></tbody>
                </table>
              </div>

              <div class="invoice-summary">
                <div class="summary-row">
                  <span class="label">Total Pages</span>
                  <span class="value" id="pvTotalPages">0</span>
                </div>
                <div class="summary-row" id="subtotalRowContainer">
                  <span class="label">Subtotal</span>
                  <span class="value" id="pvSubtotal">₱0.00</span>
                </div>
                <div
                  class="summary-row"
                  id="discountRowContainer"
                  style="display: none">
                  <span class="label"
                    >Discount (<span id="pvDiscountPercent">0</span>%)</span
                  >
                  <span
                    class="value"
                    id="pvDiscountAmount"
                    style="color: var(--success)"
                    >-₱0.00</span
                  >
                </div>
                <div
                  class="summary-row"
                  id="vatRowContainer"
                  style="display: none">
                  <span class="label"
                    >Tax/VAT (<span id="pvVatPercent">12</span>%)</span
                  >
                  <span class="value" id="pvVatAmount">₱0.00</span>
                </div>
                <div class="summary-row summary-total">
                  <span class="label">Grand Total</span>
                  <span class="value" id="pvGrand">₱0.00</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Export Actions -->
          <div class="export-section">
            <div class="section">
              <div class="section-header">
                <h2>Export Options</h2>
              </div>
              <div class="section-body">
                <div class="btn-row">
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="exportPngBtn">
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                      <circle cx="8.5" cy="8.5" r="1.5" />
                      <polyline points="21 15 16 10 5 21" />
                    </svg>
                    Export PNG
                  </button>
                  <button type="button" class="btn" id="copyImageBtn"
                    >Copy as Image</button
                  >
                  <button type="button" class="btn" id="copyTextBtn"
                    >Copy as Text</button
                  >
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="placeOrderExportBtn"
                    style="margin-left: 8px"
                    >Place Order</button
                  >
                </div>
                <p class="text-muted" style="margin-top: 12px">
                  Copy as Image requires a modern browser. If it fails, use
                  Export PNG.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
      <div class="modal">
        <div class="modal-header">
          <h3>Settings</h3>
          <button type="button" class="modal-close" id="closeSettings">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="settings-tabs">
            <button type="button" class="settings-tab active" data-tab="pricing"
              >Pricing</button
            >
            <button type="button" class="settings-tab" data-tab="display"
              >Display</button
            >
          </div>

          <!-- Pricing Tab -->
          <div class="settings-panel active" id="panel-pricing">
            <div class="form-group" style="margin-bottom: 20px">
              <label class="form-label">Base Price per Page (₱)</label>
              <input
                type="text"
                id="basePricePerPage"
                class="form-input"
                inputmode="decimal"
                placeholder="3.00" />
              <span class="form-hint"
                >Default price applied to new documents</span
              >
            </div>

            <div class="form-group" style="margin-bottom: 20px">
              <label class="form-label">Tax/VAT Percentage (%)</label>
              <input
                type="text"
                id="vatPercent"
                class="form-input"
                inputmode="decimal"
                placeholder="12" />
              <span class="form-hint"
                >Applied to invoice total after discounts</span
              >
            </div>

            <div style="margin-bottom: 16px">
              <label
                class="form-label"
                style="margin-bottom: 12px; display: block"
                >Volume Discounts (Percentage-based)</label
              >
              <div id="tierList"></div>
              <button
                type="button"
                class="btn btn-sm"
                id="addTierBtn"
                style="margin-top: 8px">
                <svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                Add Tier
              </button>
              <span class="form-hint" style="display: block; margin-top: 8px"
                >Apply percentage discount to total price when page threshold is
                reached</span
              >
            </div>
          </div>

          <!-- Display Tab -->
          <div class="settings-panel" id="panel-display">
            <div class="toggle-row">
              <div>
                <div class="toggle-label">Round to Nearest Peso</div>
                <div class="toggle-desc"
                  >Round final total to whole numbers</div
                >
              </div>
              <div class="toggle" id="toggleRoundPeso"></div>
            </div>
            <div class="toggle-row">
              <div>
                <div class="toggle-label">Color-coded Rows</div>
                <div class="toggle-desc"
                  >Highlight rows based on cost level</div
                >
              </div>
              <div class="toggle active" id="toggleColorRows"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" id="closeSettingsBtn">Done</button>
        </div>
      </div>
    </div>

    <!-- Analytics Modal -->
    <div class="modal-overlay" id="analyticsModal">
      <div class="modal">
        <div class="modal-header">
          <h3>Analytics Dashboard</h3>
          <button type="button" class="modal-close" id="closeAnalytics">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="analytics-grid">
            <div class="stat-card">
              <div class="stat-label">Total Revenue</div>
              <div class="stat-value success" id="statRevenue">₱0.00</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Pages</div>
              <div class="stat-value accent" id="statPages">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Invoices Created</div>
              <div class="stat-value" id="statInvoices">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Documents Processed</div>
              <div class="stat-value" id="statDocs">0</div>
            </div>
          </div>

          <div class="analytics-list">
            <div class="analytics-list-title">Top Clients</div>
            <div id="topClientsList">
              <div class="empty-state" style="padding: 20px">
                <p>No client data yet</p>
              </div>
            </div>
          </div>

          <div class="analytics-list" style="margin-top: 20px">
            <div class="analytics-list-title">Top-Priced Documents</div>
            <div id="topDocsList">
              <div class="empty-state" style="padding: 20px">
                <p>No document data yet</p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-danger btn-sm"
            id="clearAnalyticsBtn"
            >Clear Analytics</button
          >
          <button type="button" class="btn" id="closeAnalyticsBtn"
            >Close</button
          >
        </div>
      </div>
    </div>

    <!-- Orders Modal -->
    <div class="modal-overlay" id="ordersModal">
      <div class="modal">
        <div class="modal-header">
          <h3>Orders</h3>
          <button type="button" class="modal-close" id="closeOrders">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div style="display: flex; gap: 12px; flex-direction: column">
            <div style="display: flex; gap: 12px; flex-direction: column">
              <div style="font-weight: 600">Orders</div>
              <div style="font-size: 0.85rem; color: var(--gray-500)"
                >Manage placed orders below.</div
              >
            </div>

            <div
              style="border-top: 1px solid var(--gray-100); padding-top: 12px">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                ">
                <div style="font-weight: 600">My Orders</div>
                <div style="font-size: 0.85rem; color: var(--gray-500)"
                  >Toggle done, view details, or delete.</div
                >
              </div>
              <div id="ordersList"></div>
              <div id="ordersDetail" style="margin-top: 12px"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" id="closeOrdersBtn">Close</button>
        </div>
      </div>
    </div>

    <!-- Recent Documents Modal -->
    <div class="modal-overlay" id="recentDocsModal">
      <div class="modal">
        <div class="modal-header">
          <h3>Recent Documents</h3>
          <button type="button" class="modal-close" id="closeRecentDocs">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div id="recentDocsList" style="max-height: 400px; overflow-y: auto">
            <div class="empty-state"><p>No recent documents</p></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" id="closeRecentDocsBtn"
            >Close</button
          >
        </div>
      </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
      <div class="modal" style="max-width: 400px">
        <div class="modal-header">
          <h3 id="confirmTitle">Confirm</h3>
          <button type="button" class="modal-close" id="closeConfirm">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <p id="confirmMessage" style="color: var(--gray-600)"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" id="confirmCancel">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmOk"
            >Confirm</button
          >
        </div>
      </div>
    </div>

    <!-- Input Modal -->
    <div class="modal-overlay" id="inputModal">
      <div class="modal" style="max-width: 400px">
        <div class="modal-header">
          <h3 id="inputTitle">Enter Value</h3>
          <button type="button" class="modal-close" id="closeInput">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" id="inputLabel">Value</label>
            <input type="text" id="inputValue" class="form-input" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" id="inputCancel">Cancel</button>
          <button type="button" class="btn btn-primary" id="inputOk"
            >Apply</button
          >
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
      // ===== Utilities =====
      const clamp0 = (n) => (Number.isFinite(n) && n > 0 ? n : 0);
      const $ = (id) => document.getElementById(id);
      const escapeHtml = (s) =>
        String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");

      function parseNumber(v) {
        const n = Number(String(v).trim());
        return Number.isFinite(n) ? n : 0;
      }

      function todayISO() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
      }

      function uid() {
        return (
          crypto?.randomUUID?.() ||
          `id_${Math.random().toString(16).slice(2)}_${Date.now()}`
        );
      }

      function formatDateTime(date) {
        const d = new Date(date);
        const months = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];
        const month = months[d.getMonth()];
        const day = d.getDate();
        const year = d.getFullYear();
        let hours = d.getHours();
        const mins = String(d.getMinutes()).padStart(2, "0");
        const ampm = hours >= 12 ? "PM" : "AM";
        hours = hours % 12 || 12;
        return `${month} ${day}, ${year} - ${String(hours).padStart(2, "0")}:${mins} ${ampm}`;
      }

      function generateInvoiceNumber() {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let code = "";
        for (let i = 0; i < 4; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        const now = new Date();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        return `${code}-${month}/${day}`;
      }

      // ===== Settings State =====
      const SETTINGS_KEY = "invoice_settings_v3";
      const ANALYTICS_KEY = "invoice_analytics_v1";

      let settings = {
        basePricePerPage: 3,
        tiers: [
          { threshold: 30, discount: 5 },
          { threshold: 60, discount: 10 },
          { threshold: 100, discount: 12 },
        ],
        roundToPeso: false,
        colorCodeRows: true,
        vatPercent: 12,
      };

      let analytics = {
        totalRevenue: 0,
        totalPages: 0,
        invoicesCreated: 0,
        docsProcessed: 0,
        clients: {},
        topDocs: [],
      };

      // Recent clients and documents
      const RECENT_CLIENTS_KEY = "invoice_recent_clients_v1";
      const RECENT_DOCS_KEY = "invoice_recent_docs_v1";
      let recentClients = [];
      let recentDocuments = [];

      function loadSettings() {
        try {
          const raw = localStorage.getItem(SETTINGS_KEY);
          if (raw) {
            const s = JSON.parse(raw);
            settings = { ...settings, ...s };
          }
        } catch {}
      }

      function saveSettings() {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      }

      function loadAnalytics() {
        try {
          const raw = localStorage.getItem(ANALYTICS_KEY);
          if (raw) {
            const a = JSON.parse(raw);
            analytics = { ...analytics, ...a };
          }
        } catch {}
      }

      function saveAnalytics() {
        localStorage.setItem(ANALYTICS_KEY, JSON.stringify(analytics));
      }

      function loadRecentClients() {
        try {
          const raw = localStorage.getItem(RECENT_CLIENTS_KEY);
          recentClients = raw ? JSON.parse(raw) : [];
        } catch {}
      }

      function saveRecentClients() {
        localStorage.setItem(RECENT_CLIENTS_KEY, JSON.stringify(recentClients));
      }

      function addRecentClient(name) {
        if (!name || !name.trim()) return;
        const trimmed = name.trim();
        recentClients = recentClients.filter((c) => c !== trimmed);
        recentClients.unshift(trimmed);
        recentClients = recentClients.slice(0, 10); // Keep only 10 recent
        saveRecentClients();
      }

      function loadRecentDocuments() {
        try {
          const raw = localStorage.getItem(RECENT_DOCS_KEY);
          recentDocuments = raw ? JSON.parse(raw) : [];
        } catch {}
      }

      function saveRecentDocuments() {
        localStorage.setItem(RECENT_DOCS_KEY, JSON.stringify(recentDocuments));
      }

      function addRecentDocument(name, ext, pages) {
        if (!name || !ext) return;
        const doc = { name, ext, pages, date: new Date().toISOString() };
        recentDocuments = recentDocuments.filter(
          (d) => d.name !== name || d.ext !== ext,
        );
        recentDocuments.unshift(doc);
        recentDocuments = recentDocuments.slice(0, 20); // Keep only 20 recent
        saveRecentDocuments();
      }

      // ===== Money Formatting =====
      function money(n, round = false) {
        let val = Number.isFinite(n) ? n : 0;
        if (round || settings.roundToPeso) {
          val = Math.round(val);
        }
        return (
          "₱" +
          val.toLocaleString("en-PH", {
            minimumFractionDigits: settings.roundToPeso ? 0 : 2,
            maximumFractionDigits: settings.roundToPeso ? 0 : 2,
          })
        );
      }

      // ===== Toast =====
      function toast(title, message) {
        const container = $("toastContainer");
        const el = document.createElement("div");
        el.className = "toast";
        el.innerHTML = `<strong>${escapeHtml(title)}</strong><span>${escapeHtml(message)}</span>`;
        container.appendChild(el);
        setTimeout(() => {
          el.style.opacity = "0";
          el.style.transition = "opacity 200ms ease";
          setTimeout(() => el.remove(), 200);
        }, 2500);
      }

      function setStatus(text, online = true) {
        $("statusText").textContent = text;
        $("statusDot").className = online ? "status-dot" : "status-dot offline";
      }

      // ===== Modal Helpers =====
      function openModal(id) {
        $(id).classList.add("active");
      }

      function closeModal(id) {
        $(id).classList.remove("active");
      }

      let confirmCallback = null;
      function showConfirm(title, message) {
        return new Promise((resolve) => {
          $("confirmTitle").textContent = title;
          $("confirmMessage").textContent = message;
          openModal("confirmModal");
          confirmCallback = resolve;
        });
      }

      let inputCallback = null;
      function showInput(title, label, defaultValue = "") {
        return new Promise((resolve) => {
          $("inputTitle").textContent = title;
          $("inputLabel").textContent = label;
          $("inputValue").value = defaultValue;
          openModal("inputModal");
          inputCallback = resolve;
          setTimeout(() => $("inputValue").focus(), 100);
        });
      }

      // ===== State =====
      const STORAGE_KEY = "offline_invoice_draft_v3";

      let docs = [];
      let addedOrder = [];
      let currentInvoiceNumber = "";
      let invoiceCreatedTime = null;

      // ===== Tiered Pricing (Percentage Discounts) =====
      function getDiscountForPages(totalPages) {
        // Returns the discount percentage (0-100) based on total pages
        const sortedTiers = [...settings.tiers].sort(
          (a, b) => a.threshold - b.threshold,
        );
        let discount = 0;
        for (const tier of sortedTiers) {
          if (totalPages >= tier.threshold) {
            discount = tier.discount;
          }
        }
        return discount;
      }

      function applyDiscountToTotal(baseTotal, discountPercent) {
        // Apply percentage discount to base total
        return baseTotal * (1 - discountPercent / 100);
      }

      // ===== Totals =====
      function totals() {
        const totalPages = docs.reduce((acc, d) => acc + clamp0(d.pages), 0);

        // Calculate base total (no discounts)
        let baseTotal = docs.reduce(
          (acc, d) => acc + clamp0(d.pages) * clamp0(d.pricePerPage),
          0,
        );

        // Apply tiered discount if applicable
        let discountedTotal = baseTotal;
        let appliedDiscount = 0;
        if (settings.tiers.length > 0) {
          appliedDiscount = getDiscountForPages(totalPages);
          discountedTotal = applyDiscountToTotal(baseTotal, appliedDiscount);
        }

        // Apply VAT on the discounted total
        const vatAmount = discountedTotal * (settings.vatPercent / 100);
        const grandTotal = discountedTotal + vatAmount;

        return {
          totalPages,
          grandTotal,
          baseTotal,
          discountedTotal,
          appliedDiscount: settings.tiers.length > 0 ? appliedDiscount : 0,
          vatAmount,
          vatPercent: settings.vatPercent,
        };
      }

      // ===== Sorting =====
      function applySort() {
        const v = $("sortSelect").value;
        if (v === "added") {
          const map = new Map(addedOrder.map((id, idx) => [id, idx]));
          docs.sort((a, b) => (map.get(a.id) ?? 0) - (map.get(b.id) ?? 0));
        } else if (v === "pages_asc")
          docs.sort((a, b) => clamp0(a.pages) - clamp0(b.pages));
        else if (v === "pages_desc")
          docs.sort((a, b) => clamp0(b.pages) - clamp0(a.pages));
        else if (v === "total_asc")
          docs.sort(
            (a, b) =>
              clamp0(a.pages) * clamp0(a.pricePerPage) -
              clamp0(b.pages) * clamp0(b.pricePerPage),
          );
        else if (v === "total_desc")
          docs.sort(
            (a, b) =>
              clamp0(b.pages) * clamp0(b.pricePerPage) -
              clamp0(a.pages) * clamp0(a.pricePerPage),
          );
      }

      // ===== Row Color Coding =====
      function getRowClass(pages, total) {
        if (!settings.colorCodeRows) return "";
        if (total >= 200) return "row-very-high";
        if (total >= 100) return "row-high";
        if (total >= 50) return "row-medium";
        return "row-low";
      }

      // ===== Render =====
      function render() {
        applySort();

        const tb = $("tbody");
        tb.innerHTML = "";

        if (docs.length === 0) {
          tb.innerHTML = `<tr class="empty-row"><td colspan="5"><div class="empty-state"><p>No documents yet. Upload PDF or DOCX files to get started.</p></div></td></tr>`;
        } else {
          for (const d of docs) {
            const total = clamp0(d.pages) * clamp0(d.pricePerPage);
            const sub =
              d.ext === "docx" && d.docxPageSource
                ? `DOCX (${d.docxPageSource})`
                : d.ext === "pdf"
                  ? "PDF"
                  : "";
            const sizeLabel =
              d.pageSize === "long"
                ? "(Long)"
                : d.pageSize === "a4"
                  ? "(A4)"
                  : "(Letter)";
            const colorLabel = d.hasColors ? " [Color]" : "";
            const rowClass = getRowClass(d.pages, total);
            const tr = document.createElement("tr");
            tr.className = rowClass;
            tr.innerHTML = `
              <td><div class="doc-name"><strong>${escapeHtml(d.name)}</strong><span>${escapeHtml(sub)} ${sizeLabel}${colorLabel}</span></div></td>
              <td class="num"><input type="text" class="form-input" data-id="${d.id}" data-field="pages" inputmode="numeric" value="${clamp0(d.pages) || 0}" /></td>
              <td class="num"><input type="text" class="form-input" data-id="${d.id}" data-field="pricePerPage" inputmode="decimal" value="${clamp0(d.pricePerPage) || 0}" /></td>
              <td class="num"><span class="doc-total">${money(total)}</span></td>
              <td><button type="button" class="btn btn-ghost btn-sm" data-id="${d.id}" data-action="remove">✕</button></td>
            `;
            tb.appendChild(tr);
          }
        }

        // Preview
        $("pvClient").textContent = $("clientName").value.trim() || "—";
        const r = $("remarks").value.trim();
        $("pvRemarks").textContent = r
          ? r.length > 50
            ? r.slice(0, 47) + "…"
            : r
          : "—";
        $("pvDate").textContent = $("invoiceDate").value || "—";
        $("pvInv").textContent = currentInvoiceNumber || "—";

        const pvTb = $("pvTable");
        pvTb.innerHTML = "";
        if (docs.length === 0) {
          pvTb.innerHTML = `<tr><td colspan="4" style="text-align:center;color:var(--gray-400);padding:24px;">No items</td></tr>`;
        } else {
          for (const d of docs) {
            const total = clamp0(d.pages) * clamp0(d.pricePerPage);
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><div class="doc-name"><strong>${escapeHtml(d.name)}</strong></div></td>
              <td class="num">${clamp0(d.pages)}</td>
              <td class="num">${money(clamp0(d.pricePerPage))}</td>
              <td class="num"><strong>${money(total)}</strong></td>
            `;
            pvTb.appendChild(tr);
          }
        }

        const t = totals();
        $("pvTotalPages").textContent = t.totalPages;
        $("pvSubtotal").textContent = money(t.baseTotal);
        $("pvGrand").textContent = money(t.grandTotal);

        // Show discount if applicable
        const discountContainer = $("discountRowContainer");
        if (t.appliedDiscount > 0) {
          const discountAmount = t.baseTotal - t.discountedTotal;
          $("pvDiscountPercent").textContent = t.appliedDiscount;
          $("pvDiscountAmount").textContent = "-" + money(discountAmount);
          discountContainer.style.display = "flex";
        } else {
          discountContainer.style.display = "none";
        }

        // Show VAT if applicable
        const vatContainer = $("vatRowContainer");
        if (t.vatAmount > 0) {
          $("pvVatPercent").textContent = t.vatPercent;
          $("pvVatAmount").textContent = "+" + money(t.vatAmount);
          vatContainer.style.display = "flex";
        } else {
          vatContainer.style.display = "none";
        }

        saveDraft();
      }

      function flashInvoice() {
        const area = $("invoiceArea");
        area.classList.remove("flash");
        void area.offsetWidth;
        area.classList.add("flash");
      }

      // ===== Persistence =====
      function saveDraft() {
        const draft = {
          v: 3,
          docs,
          addedOrder,
          currentInvoiceNumber,
          invoiceCreatedTime,
          form: {
            clientName: $("clientName").value,
            invoiceDate: $("invoiceDate").value,
            remarks: $("remarks").value,
            sort: $("sortSelect").value,
          },
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(draft));
      }

      function loadDraft() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
          const d = JSON.parse(raw);
          if (!d || d.v !== 3) return;
          docs = Array.isArray(d.docs) ? d.docs : [];
          addedOrder = Array.isArray(d.addedOrder)
            ? d.addedOrder
            : docs.map((x) => x.id);
          currentInvoiceNumber =
            d.currentInvoiceNumber || generateInvoiceNumber();
          invoiceCreatedTime = d.invoiceCreatedTime || new Date().toISOString();
          const f = d.form || {};
          $("clientName").value = f.clientName || "";
          $("invoiceDate").value = f.invoiceDate || todayISO();
          $("remarks").value = f.remarks || "";
          $("sortSelect").value = f.sort || "added";
        } catch {}
      }

      // ===== File Parsing =====
      async function analyzePdfDocument(arrayBuffer) {
        console.log("[analyzePdfDocument] Starting PDF analysis", {
          size: arrayBuffer.byteLength,
        });

        if (!window.pdfjsLib) {
          console.error("[analyzePdfDocument] pdf.js library not loaded");
          throw new Error("pdf.js not loaded");
        }

        try {
          window.pdfjsLib.GlobalWorkerOptions.workerSrc =
            "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
          console.log("[analyzePdfDocument] Worker source set");
        } catch (e) {
          console.warn("[analyzePdfDocument] Could not set worker source:", e);
        }

        try {
          const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer })
            .promise;
          const pages = pdf.numPages || 0;
          console.log(`[analyzePdfDocument] PDF loaded: ${pages} pages`);

          let pageSize = "unknown";
          let hasColors = false;

          try {
            const firstPage = await pdf.getPage(1);
            const viewport = firstPage.getViewport({ scale: 1 });
            const width = viewport.width;
            const height = viewport.height;
            console.log(
              `[analyzePdfDocument] First page size: ${width}x${height}pt`,
            );

            const inchW = width / 72;
            const inchH = height / 72;

            const tolerance = 0.2;
            if (
              (Math.abs(inchW - 8.5) < tolerance &&
                Math.abs(inchH - 13) < tolerance) ||
              (Math.abs(inchW - 13) < tolerance &&
                Math.abs(inchH - 8.5) < tolerance)
            ) {
              pageSize = "long";
            } else if (
              (Math.abs(inchW - 8.5) < tolerance &&
                Math.abs(inchH - 11) < tolerance) ||
              (Math.abs(inchW - 11) < tolerance &&
                Math.abs(inchH - 8.5) < tolerance)
            ) {
              pageSize = "short";
            } else if (
              (Math.abs(inchW - 8.27) < tolerance &&
                Math.abs(inchH - 11.69) < tolerance) ||
              (Math.abs(inchW - 11.69) < tolerance &&
                Math.abs(inchH - 8.27) < tolerance)
            ) {
              pageSize = "a4";
            }
            console.log(`[analyzePdfDocument] Detected page size: ${pageSize}`);

            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = Math.min(viewport.width, 300);
            canvas.height = Math.min(viewport.height, 300);

            await firstPage.render({
              canvasContext: context,
              viewport: firstPage.getViewport({
                scale: canvas.width / viewport.width,
              }),
            }).promise;
            console.log("[analyzePdfDocument] Page rendered to canvas");

            const imageData = context.getImageData(
              0,
              0,
              canvas.width,
              canvas.height,
            );
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
              const r = data[i];
              const g = data[i + 1];
              const b = data[i + 2];
              const a = data[i + 3];

              if (a > 128) {
                const isGrayscale = r === g && g === b;
                const isBlackOrWhite =
                  (r === 0 && g === 0 && b === 0) ||
                  (r === 255 && g === 255 && b === 255);

                if (!isGrayscale && !isBlackOrWhite) {
                  hasColors = true;
                  console.log("[analyzePdfDocument] Detected colors in PDF");
                  break;
                }
              }
            }
          } catch (e) {
            console.warn("[analyzePdfDocument] Error analyzing first page:", e);
          }

          console.log("[analyzePdfDocument] Analysis result:", {
            pages,
            pageSize,
            hasColors,
          });
          return { pages, pageSize, hasColors };
        } catch (e) {
          console.error("[analyzePdfDocument] Fatal error:", e);
          throw e;
        }
      }

      async function analyzeDocxDocument(arrayBuffer) {
        console.log("[analyzeDocxDocument] Starting DOCX analysis", {
          size: arrayBuffer.byteLength,
        });

        if (!window.JSZip) {
          console.error("[analyzeDocxDocument] JSZip library not loaded");
          throw new Error("JSZip not loaded");
        }

        try {
          const zip = await window.JSZip.loadAsync(arrayBuffer);
          console.log("[analyzeDocxDocument] DOCX file extracted as ZIP");

          let pages = 1;
          let source = "manual";
          let pageSize = "short";
          let hasColors = false;

          const app = zip.file("docProps/app.xml");
          if (app) {
            try {
              const xml = await app.async("text");
              const m = xml.match(/<Pages>(\d+)<\/Pages>/);
              if (m) {
                pages = parseInt(m[1], 10);
                source = "metadata";
                console.log(
                  `[analyzeDocxDocument] Found pages in metadata: ${pages}`,
                );
              }
            } catch (e) {
              console.warn("[analyzeDocxDocument] Error reading app.xml:", e);
            }
          }

          if (!pages || pages === 1) {
            console.log(
              "[analyzeDocxDocument] Pages not found or is 1, trying Mammoth estimation",
            );
            if (window.mammoth) {
              try {
                const result = await window.mammoth.extractRawText({
                  arrayBuffer,
                });
                const words = (result?.value || "")
                  .trim()
                  .split(/\s+/)
                  .filter(Boolean).length;
                pages = Math.max(1, Math.ceil(words / 280));
                source = "estimated";
                console.log(
                  `[analyzeDocxDocument] Estimated pages from word count: ${pages} pages (${words} words)`,
                );
              } catch (e) {
                console.warn("[analyzeDocxDocument] Error with Mammoth:", e);
              }
            } else {
              console.warn(
                "[analyzeDocxDocument] Mammoth not loaded, cannot estimate pages",
              );
            }
          }

          try {
            const docXml = zip.file("word/document.xml");
            if (docXml) {
              const xml = await docXml.async("text");
              if (/w:color="(?!000000|ffffff)[0-9A-Fa-f]{6}"/.test(xml)) {
                hasColors = true;
                console.log("[analyzeDocxDocument] Detected colors in DOCX");
              }
            }
          } catch (e) {
            console.warn("[analyzeDocxDocument] Error checking colors:", e);
          }

          try {
            const docXml = zip.file("word/document.xml");
            if (docXml) {
              const xml = await docXml.async("text");
              const heightMatch = xml.match(/<w:pgSz[^>]*w:h="(\d+)"/);
              if (heightMatch) {
                const heightTwips = parseInt(heightMatch[1], 10);
                const heightInches = heightTwips / 1440;
                console.log(
                  `[analyzeDocxDocument] Page height: ${heightInches}" (${heightTwips} twips)`,
                );

                if (Math.abs(heightInches - 13) < 0.2) {
                  pageSize = "long";
                } else if (Math.abs(heightInches - 11) < 0.2) {
                  pageSize = "short";
                } else if (Math.abs(heightInches - 11.69) < 0.2) {
                  pageSize = "a4";
                }
                console.log(
                  `[analyzeDocxDocument] Detected page size: ${pageSize}`,
                );
              }
            }
          } catch (e) {
            console.warn("[analyzeDocxDocument] Error checking page size:", e);
          }

          console.log("[analyzeDocxDocument] Analysis result:", {
            pages,
            source,
            pageSize,
            hasColors,
          });
          return { pages, source, pageSize, hasColors };
        } catch (e) {
          console.error("[analyzeDocxDocument] Fatal error:", e);
          throw e;
        }
      }

      function fileExt(name) {
        const parts = name.toLowerCase().split(".");
        return parts.length > 1 ? parts.pop() : "";
      }

      function getPriceFromDocumentProperties(pageSize, hasColors) {
        const basePrices = {
          long: 3.0,
          short: 2.0,
          a4: 2.0,
          unknown: 2.5,
        };

        let price = basePrices[pageSize] || basePrices.unknown;
        if (hasColors) {
          price += 0.5;
        }

        return price;
      }

      function stripFilename(filename, maxLength = 35) {
        // Remove extension
        let name = filename.replace(/\.[^.]+$/, "");

        // Clean up separators: multiple spaces/underscores/dashes to single space
        name = name.replace(/[\s_\-]+/g, " ").trim();

        // Truncate if too long
        if (name.length > maxLength) {
          // Try to cut at a word boundary
          let truncated = name.substring(0, maxLength - 1);
          const lastSpace = truncated.lastIndexOf(" ");
          if (lastSpace > maxLength / 2) {
            truncated = truncated.substring(0, lastSpace);
          }
          name = truncated + "…";
        }

        return name || "Document";
      }

      async function addFiles(fileList) {
        console.log("[addFiles] Starting with fileList:", fileList);
        const files = Array.from(fileList || []);
        console.log(
          `[addFiles] Converted to array, found ${files.length} files`,
        );

        if (!files.length) {
          console.log("[addFiles] No files to process");
          return;
        }

        setStatus("Processing…");
        console.log("[addFiles] Status set to Processing");

        for (let i = 0; i < files.length; i++) {
          const f = files[i];
          console.log(
            `[addFiles] Processing file ${i + 1}/${files.length}: ${f.name} (${f.size} bytes)`,
          );

          const ext = fileExt(f.name);
          console.log(`[addFiles] File extension: ${ext}`);

          if (ext !== "pdf" && ext !== "docx") {
            console.log(`[addFiles] Skipping ${f.name} - unsupported format`);
            toast("Skipped", `${f.name} — only PDF/DOCX supported`);
            continue;
          }

          const id = uid();
          const doc = {
            id,
            name: stripFilename(f.name),
            ext,
            pages: 0,
            pricePerPage: 0,
            pageSize: "unknown",
            hasColors: false,
          };
          docs.push(doc);
          addedOrder.push(id);
          console.log(`[addFiles] Added document to list with ID: ${id}`);
          render();

          try {
            console.log(`[addFiles] Reading arrayBuffer for ${f.name}`);
            const ab = await f.arrayBuffer();
            console.log(
              `[addFiles] ArrayBuffer ready, size: ${ab.byteLength} bytes`,
            );
            let analysisResult;

            if (ext === "pdf") {
              console.log(`[addFiles] Analyzing PDF: ${f.name}`);
              analysisResult = await analyzePdfDocument(ab);
              console.log(`[addFiles] PDF analysis complete:`, analysisResult);
            } else {
              console.log(`[addFiles] Analyzing DOCX: ${f.name}`);
              analysisResult = await analyzeDocxDocument(ab);
              console.log(`[addFiles] DOCX analysis complete:`, analysisResult);
            }

            doc.pages = analysisResult.pages;
            doc.pageSize = analysisResult.pageSize;
            doc.hasColors = analysisResult.hasColors;
            doc.pricePerPage = getPriceFromDocumentProperties(
              doc.pageSize,
              doc.hasColors,
            );

            if (ext === "docx") {
              doc.docxPageSource = analysisResult.source;
            }

            const sizeLabel =
              doc.pageSize === "long"
                ? "(Long)"
                : doc.pageSize === "a4"
                  ? "(A4)"
                  : "(Letter)";
            const colorLabel = doc.hasColors ? " [Color]" : "";
            const strippedName = stripFilename(f.name);
            console.log(
              `[addFiles] Document processed: ${strippedName} - ${doc.pages} pages, ${sizeLabel}${colorLabel}`,
            );

            toast(
              "Added",
              `${strippedName}${sizeLabel}${colorLabel} — ${doc.pages} page(s) @ ₱${doc.pricePerPage.toFixed(2)}/page`,
            );

            // Track recent documents
            addRecentDocument(stripFilename(f.name), ext, doc.pages);

            analytics.docsProcessed++;
            saveAnalytics();
          } catch (e) {
            console.error(`[addFiles] Error processing file ${f.name}:`, e);
            doc.pages = 1;
            doc.pageSize = "unknown";
            doc.hasColors = false;
            doc.pricePerPage = getPriceFromDocumentProperties("unknown", false);
            toast("Analysis partial", `${f.name}: detected manually`);
          }

          render();
          flashInvoice();
        }

        setStatus("Ready");
        console.log(`[addFiles] Complete - processed ${files.length} files`);
      }

      // ===== Export =====
      async function invoiceToPngBlob() {
        if (!window.html2canvas) throw new Error("html2canvas not loaded");

        // Hide subtotal and VAT rows for export (user requested not to include in image)
        const subtotalContainer = $("subtotalRowContainer");
        const vatContainer = $("vatRowContainer");
        const subtotalWasVisible = subtotalContainer.style.display !== "none";
        const vatWasVisible = vatContainer.style.display !== "none";

        if (subtotalWasVisible) subtotalContainer.style.display = "none";
        if (vatWasVisible) vatContainer.style.display = "none";

        try {
          const canvas = await window.html2canvas($("invoiceArea"), {
            backgroundColor: "#ffffff",
            scale: 2,
            useCORS: true,
          });
          return await new Promise((res) => canvas.toBlob(res, "image/png"));
        } finally {
          // Restore rows
          if (subtotalWasVisible) subtotalContainer.style.display = "flex";
          if (vatWasVisible) vatContainer.style.display = "flex";
        }
      }

      async function exportPng() {
        try {
          setStatus("Exporting…");
          const blob = await invoiceToPngBlob();
          if (!blob) throw new Error("Failed");
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${currentInvoiceNumber || "invoice"}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          toast("Exported", "PNG downloaded");
          recordInvoice();
        } catch {
          toast("Export failed", "Could not export PNG");
        } finally {
          setStatus("Ready");
        }
      }

      async function copyAsImage() {
        try {
          setStatus("Copying…");
          const blob = await invoiceToPngBlob();
          if (!blob) throw new Error("Failed to generate image");

          // Try modern Clipboard API first
          if (navigator.clipboard?.write && window.ClipboardItem) {
            try {
              await navigator.clipboard.write([
                new ClipboardItem({ "image/png": blob }),
              ]);
              toast("Copied", "Invoice image copied to clipboard");
              recordInvoice();
              setStatus("Ready");
              return;
            } catch {}
          }

          // Fallback: Convert blob to data URL and try clipboard
          const reader = new FileReader();
          reader.onload = async () => {
            try {
              if (navigator.clipboard?.writeText) {
                await navigator.clipboard.writeText(reader.result);
              } else {
                const textarea = document.createElement("textarea");
                textarea.value = reader.result;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand("copy");
                document.body.removeChild(textarea);
              }
              toast("Copied", "Image data URL copied");
              recordInvoice();
            } catch {
              throw new Error("Fallback failed");
            } finally {
              setStatus("Ready");
            }
          };
          reader.onerror = () => {
            throw new Error("FileReader failed");
          };
          reader.readAsDataURL(blob);
        } catch (e) {
          toast("Copy failed", "Use Export PNG button instead");
          setStatus("Ready");
        }
      }

      async function copyAsText() {
        const t = totals();
        const orderedTime = invoiceCreatedTime
          ? formatDateTime(invoiceCreatedTime)
          : formatDateTime(new Date());

        // Group documents by price
        const groups = {};
        for (const d of docs) {
          const price = clamp0(d.pricePerPage);
          const key = `${d.name}_${price}`;
          if (!groups[key]) {
            groups[key] = { name: d.name, price, copies: 0, total: 0 };
          }
          groups[key].copies += clamp0(d.pages);
          groups[key].total += clamp0(d.pages) * price;
        }

        let lines = [
          `NAME: ${$("clientName").value.trim() || "—"}`,
          ``,
          `Ordered: ${orderedTime}`,
          `Order #${currentInvoiceNumber}`,
          ``,
          `**ORDER DETAILS**`,
          ``,
        ];

        // Add statics section
        lines.push(`**STATICS**`);
        for (const d of docs) {
          const copies = clamp0(d.pages);
          const price = clamp0(d.pricePerPage);
          const total = copies * price;
          lines.push(`  • ${d.name} (${money(price)} each)`);
          lines.push(`    └─ **${copies} copies** → ${money(total)}`);
        }

        lines.push(``);
        lines.push(`📄 **PAPER USAGE: ${t.totalPages} sheets**`);
        lines.push(`💰 **TOTAL: ${money(t.grandTotal)}**`);

        try {
          await navigator.clipboard.writeText(lines.join("\n"));
          toast("Copied", "Text copied to clipboard");
          recordInvoice();
        } catch {
          toast("Copy failed", "Clipboard unavailable");
        }
      }

      function recordInvoice() {
        const t = totals();
        const clientName = $("clientName").value.trim();

        // Update analytics
        analytics.totalRevenue += t.grandTotal;
        analytics.totalPages += t.totalPages;
        analytics.invoicesCreated++;

        // Track client
        if (clientName) {
          if (!analytics.clients[clientName]) {
            analytics.clients[clientName] = { revenue: 0, invoices: 0 };
          }
          analytics.clients[clientName].revenue += t.grandTotal;
          analytics.clients[clientName].invoices++;
        }

        // Track top docs
        for (const d of docs) {
          const total = clamp0(d.pages) * clamp0(d.pricePerPage);
          analytics.topDocs.push({
            name: d.name,
            total,
            date: new Date().toISOString(),
          });
        }
        // Keep only top 50
        analytics.topDocs.sort((a, b) => b.total - a.total);
        analytics.topDocs = analytics.topDocs.slice(0, 50);

        saveAnalytics();
      }

      // ===== Orders =====
      const ORDERS_KEY = "offline_invoice_orders_v1";
      let orders = [];

      function loadOrders() {
        try {
          const raw = localStorage.getItem(ORDERS_KEY);
          if (raw) orders = JSON.parse(raw);
          else orders = [];
        } catch {
          orders = [];
        }
      }

      function saveOrders() {
        localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
      }

      function placeOrderFromCurrentInvoice({ clearAfter = true } = {}) {
        if (!docs || docs.length === 0) {
          toast("Empty", "No documents to place order");
          return;
        }

        const t = totals();
        const order = {
          id: uid(),
          invoiceNumber: currentInvoiceNumber || generateInvoiceNumber(),
          client: $("clientName").value.trim() || "—",
          remarks: $("remarks").value.trim() || "",
          docs: docs.map((d) => ({
            name: d.name,
            pages: clamp0(d.pages),
            pricePerPage: clamp0(d.pricePerPage),
            total: clamp0(d.pages) * clamp0(d.pricePerPage),
          })),
          totals: {
            totalPages: t.totalPages,
            baseTotal: t.baseTotal,
            grandTotal: t.grandTotal,
            appliedDiscount: t.appliedDiscount,
          },
          createdAt: new Date().toISOString(),
          done: false,
        };

        // Record analytics for this invoice
        recordInvoice();

        orders.unshift(order);
        saveOrders();
        renderOrders();

        // Optionally clear current documents after placing order
        if (clearAfter) {
          docs = [];
          addedOrder = [];
          // bump invoice number and created time for next order
          currentInvoiceNumber = generateInvoiceNumber();
          invoiceCreatedTime = new Date().toISOString();
          $("invoiceNumber").value = currentInvoiceNumber;
          render();
          flashInvoice();
          toast(
            "Order placed",
            `Order ${order.invoiceNumber} placed — documents cleared`,
          );
        } else {
          toast("Order placed", `Order ${order.invoiceNumber} placed`);
        }
      }

      function renderOrders() {
        const container = $("ordersList");
        if (!container) return;
        if (!orders || orders.length === 0) {
          container.innerHTML = `<div class="empty-state"><p>No orders yet</p></div>`;
          $("ordersDetail").innerHTML = "";
          return;
        }
        // Render as compact cards
        container.innerHTML = orders
          .map(
            (o) => `
              <div class="section" style="margin-bottom:10px;padding:10px;">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
                  <div style="flex:1;min-width:0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                      <div style="min-width:0">
                        <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(o.client || "—")}</div>
                        <div style="color:var(--gray-500);font-size:0.85rem;white-space:nowrap">${escapeHtml(o.invoiceNumber)}</div>
                      </div>
                      <div style="text-align:right">
                        <div style="font-size:1.25rem;font-weight:700">${money(o.totals.grandTotal)}</div>
                        <div style="color:var(--gray-500);font-size:0.8rem">${o.totals.totalPages} pages</div>
                      </div>
                    </div>
                    <div style="margin-top:8px;color:var(--gray-500);font-size:0.8rem">${escapeHtml(formatDateTime(o.createdAt))}</div>
                  </div>
                  <div style="display:flex;flex-direction:column;gap:8px">
                    <div style="display:flex;gap:8px">
                      <button class="btn btn-sm" data-action="toggle" data-id="${o.id}">${o.done ? "Done" : "Mark Done"}</button>
                      <button class="btn btn-ghost btn-sm" data-action="view" data-id="${o.id}">View</button>
                      <button class="btn btn-danger btn-sm" data-action="delete" data-id="${o.id}">Delete</button>
                    </div>
                  </div>
                </div>
              </div>
            `,
          )
          .join("");
      }

      function toggleOrderDone(id) {
        const o = orders.find((x) => x.id === id);
        if (!o) return;
        // When marking done, clear the order from the list (archive)
        if (!o.done) {
          // confirm completion
          showConfirm(
            "Complete Order",
            `Mark ${o.invoiceNumber} as done and clear it?`,
          ).then((confirmed) => {
            if (!confirmed) return;
            // mark done and remove
            o.done = true;
            // remove from orders list
            orders = orders.filter((x) => x.id !== id);
            saveOrders();
            renderOrders();
            // clear detail view if showing this
            const det = $("ordersDetail");
            if (det && det.dataset && det.dataset.currentId === id) {
              det.innerHTML = "";
              delete det.dataset.currentId;
            }
            toast("Completed", `${o.invoiceNumber} cleared`);
          });
          return;
        }

        // If already marked done in data (rare because we clear), just remove
        orders = orders.filter((x) => x.id !== id);
        saveOrders();
        renderOrders();
        toast("Cleared", `${o.invoiceNumber}`);
      }

      function deleteOrderById(id) {
        orders = orders.filter((x) => x.id !== id);
        saveOrders();
        renderOrders();
        toast("Deleted", "Order removed");
      }

      function viewOrderDetails(id) {
        const o = orders.find((x) => x.id === id);
        const det = $("ordersDetail");
        if (!o) {
          det.innerHTML = "";
          return;
        }
        det.innerHTML = `
          <div class="order-detail-card" style="position:relative;padding:12px;border:1px solid var(--gray-100);border-radius:8px;background:var(--white)">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div>
                <strong>${escapeHtml(o.client)}</strong>
                <div style="font-size:0.85rem;color:var(--gray-500)">${escapeHtml(formatDateTime(o.createdAt))}</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button class="btn btn-ghost btn-sm" data-detail-action="minimize">_</button>
                <button class="btn btn-ghost btn-sm" data-detail-action="maximize">◻</button>
                <button class="btn btn-ghost btn-sm" data-detail-action="close">✕</button>
              </div>
            </div>
            <div style="margin-bottom:8px"><strong>Invoice:</strong> ${escapeHtml(o.invoiceNumber)}</div>
            <div style="margin-bottom:8px"><strong>Totals:</strong> ${money(o.totals.grandTotal)} • ${o.totals.totalPages} pages</div>
            <div style="margin-top:12px">
              <div style="font-weight:600;margin-bottom:8px">Items</div>
              <div class="table-wrapper">
                <table class="table" style="min-width:420px;margin-bottom:0">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th class="num">Pages</th>
                      <th class="num">Price</th>
                      <th class="num">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${o.docs
                      .map(
                        (it) => `
                          <tr>
                            <td style="max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(it.name)}</td>
                            <td class="num">${it.pages}</td>
                            <td class="num">${money(it.pricePerPage)}</td>
                            <td class="num">${money(it.total)}</td>
                          </tr>
                        `,
                      )
                      .join("")}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
        det.scrollIntoView({ behavior: "smooth" });
      }

      // ===== Settings UI =====
      function renderTiers() {
        const list = $("tierList");
        list.innerHTML = "";

        if (settings.tiers.length === 0) {
          list.innerHTML = `<p style="color: var(--gray-400); font-size: 0.85rem; padding: 8px 0;">No tiers configured. All pages charged at base price.</p>`;
          return;
        }

        for (let i = 0; i < settings.tiers.length; i++) {
          const tier = settings.tiers[i];
          const row = document.createElement("div");
          row.className = "tier-row";
          row.innerHTML = `
            <div>
              <input type="text" class="form-input" data-tier="${i}" data-field="threshold" value="${tier.threshold}" placeholder="Pages" />
              <span class="tier-label">pages or more</span>
            </div>
            <span class="tier-arrow">→</span>
            <div>
              <input type="text" class="form-input" data-tier="${i}" data-field="discount" value="${tier.discount}" placeholder="0" inputmode="numeric" />
              <span class="tier-discount-label">% discount</span>
            </div>
            <button type="button" class="tier-remove" data-tier="${i}">✕</button>
          `;
          list.appendChild(row);
        }
      }

      function renderAnalytics() {
        $("statRevenue").textContent = money(analytics.totalRevenue);
        $("statPages").textContent = analytics.totalPages.toLocaleString();
        $("statInvoices").textContent = analytics.invoicesCreated;
        $("statDocs").textContent = analytics.docsProcessed;

        // Top clients
        const clientsList = $("topClientsList");
        const clientsArr = Object.entries(analytics.clients)
          .map(([name, data]) => ({ name, ...data }))
          .sort((a, b) => b.revenue - a.revenue)
          .slice(0, 5);

        if (clientsArr.length === 0) {
          clientsList.innerHTML = `<div class="empty-state" style="padding: 20px;"><p>No client data yet</p></div>`;
        } else {
          clientsList.innerHTML = clientsArr
            .map(
              (c) => `
            <div class="analytics-list-item">
              <span class="name">${escapeHtml(c.name)}</span>
              <span class="value">${money(c.revenue)}</span>
            </div>
          `,
            )
            .join("");
        }

        // Top docs
        const docsList = $("topDocsList");
        const topDocs = analytics.topDocs.slice(0, 5);

        if (topDocs.length === 0) {
          docsList.innerHTML = `<div class="empty-state" style="padding: 20px;"><p>No document data yet</p></div>`;
        } else {
          docsList.innerHTML = topDocs
            .map(
              (d) => `
            <div class="analytics-list-item">
              <span class="name">${escapeHtml(d.name)}</span>
              <span class="value">${money(d.total)}</span>
            </div>
          `,
            )
            .join("");
        }
      }

      function updateSettingsUI() {
        $("basePricePerPage").value = settings.basePricePerPage;
        $("vatPercent").value = settings.vatPercent;
        $("toggleRoundPeso").className = settings.roundToPeso
          ? "toggle active"
          : "toggle";
        $("toggleColorRows").className = settings.colorCodeRows
          ? "toggle active"
          : "toggle";
        renderTiers();
        renderClientHistory();
      }

      function renderClientHistory() {
        const datalist = $("clientHistory");
        datalist.innerHTML = "";
        recentClients.forEach((client) => {
          const option = document.createElement("option");
          option.value = client;
          datalist.appendChild(option);
        });
      }

      function renderRecentDocuments() {
        const container = $("recentDocsList");
        if (!recentDocuments || recentDocuments.length === 0) {
          container.innerHTML = `<div class="empty-state"><p>No recent documents</p></div>`;
          return;
        }

        container.innerHTML = recentDocuments
          .map(
            (doc) => `
            <div class="analytics-list-item" style="padding: 12px 0; border-bottom: 1px solid var(--gray-100);">
              <div style="flex: 1;">
                <div style="font-weight: 500; margin-bottom: 4px;">${escapeHtml(doc.name)}</div>
                <div style="font-size: 0.8rem; color: var(--gray-500);">
                  ${doc.ext.toUpperCase()} • ${doc.pages} pages • ${formatDateTime(doc.date)}
                </div>
              </div>
            </div>
          `,
          )
          .join("");
      }

      // Detail panel controls: minimize / maximize / close
      document.addEventListener("click", (e) => {
        const btn =
          e.target.closest && e.target.closest("[data-detail-action]");
        if (!btn) return;
        const action = btn.dataset.detailAction;
        const det = document.getElementById("ordersDetail");
        if (!det) return;
        if (action === "close") {
          det.innerHTML = "";
          delete det.dataset.currentId;
          det.classList.remove("detail-collapsed");
          det.classList.remove("detail-expanded");
        } else if (action === "minimize") {
          det.classList.toggle("detail-collapsed");
        } else if (action === "maximize") {
          det.classList.toggle("detail-expanded");
        }
      });

      // Add simple styles for collapsed/expanded detail state
      const styleEl = document.createElement("style");
      styleEl.textContent = `
        #ordersDetail.detail-collapsed { max-height: 48px; overflow: hidden; }
        #ordersDetail.detail-expanded { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 900px; height: 80vh; z-index: 1300; overflow: auto; }
        #ordersDetail.detail-expanded .order-detail-card { height: 100%; }
      `;
      document.head.appendChild(styleEl);

      // ===== Events =====
      function bindEvents() {
        const fileInput = $("fileInput");

        console.log("bindEvents called, fileInput:", fileInput);

        if (fileInput) {
          fileInput.addEventListener("change", function (e) {
            console.log("File input changed, files:", this.files);
            const files = this.files;
            if (files && files.length > 0) {
              addFiles(files);
              this.value = "";
            }
          });
        } else {
          console.error("File input element not found");
        }

        // Drag and drop support
        const uploadBtn = $("uploadBtn");
        const docsTable = $("docsTable");
        const sectionBody = uploadBtn?.closest(".section-body");
        const dropZones = [uploadBtn, docsTable, sectionBody].filter(Boolean);

        function handleDragOver(e) {
          e.preventDefault();
          e.stopPropagation();
          e.dataTransfer.dropEffect = "copy";
          if (sectionBody) {
            sectionBody.style.backgroundColor = "rgba(37, 99, 235, 0.05)";
            sectionBody.style.borderTop = "2px dashed var(--accent)";
            sectionBody.style.borderRadius = "var(--radius-lg)";
          }
        }

        function handleDragLeave(e) {
          e.preventDefault();
          e.stopPropagation();
          if (sectionBody) {
            sectionBody.style.backgroundColor = "";
            sectionBody.style.borderTop = "";
            sectionBody.style.borderRadius = "";
          }
        }

        function handleDrop(e) {
          e.preventDefault();
          e.stopPropagation();
          if (sectionBody) {
            sectionBody.style.backgroundColor = "";
            sectionBody.style.borderTop = "";
            sectionBody.style.borderRadius = "";
          }
          const files = e.dataTransfer?.files;
          if (files && files.length > 0) {
            addFiles(files);
          }
        }

        // Add event listeners to all drop zones
        dropZones.forEach((zone) => {
          zone.addEventListener("dragover", handleDragOver);
          zone.addEventListener("dragenter", handleDragOver);
          zone.addEventListener("dragleave", handleDragLeave);
          zone.addEventListener("drop", handleDrop);
        });

        // Also add to document body for whole page drag-drop
        document.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "copy";
        });
        document.addEventListener("drop", (e) => {
          e.preventDefault();
        });

        $("clearBtn").addEventListener("click", async () => {
          const confirmed = await showConfirm(
            "Clear All Documents",
            "Are you sure you want to clear all documents from this invoice?",
          );
          if (!confirmed) return;
          docs = [];
          addedOrder = [];
          render();
          flashInvoice();
        });

        $("newInvoiceBtn").addEventListener("click", async () => {
          const confirmed = await showConfirm(
            "Start New Invoice",
            "This will clear all current data and start a fresh invoice. Continue?",
          );
          if (!confirmed) return;
          docs = [];
          addedOrder = [];
          $("clientName").value = "";
          $("remarks").value = "";
          $("invoiceDate").value = todayISO();
          currentInvoiceNumber = generateInvoiceNumber();
          invoiceCreatedTime = new Date().toISOString();
          render();
          flashInvoice();
          toast("New Invoice", "Started fresh invoice");
        });

        $("sortSelect").addEventListener("change", () => render());

        // Client name tracking
        $("clientName").addEventListener("change", () => {
          addRecentClient($("clientName").value);
          renderClientHistory();
        });

        ["clientName", "invoiceDate", "remarks"].forEach((id) => {
          $(id).addEventListener("input", () => {
            render();
            flashInvoice();
          });
        });

        // Update document fields (pages / price) when edited inline
        let inputDebounceTimer = null;
        $("tbody").addEventListener("input", (e) => {
          if (!(e.target instanceof HTMLInputElement)) return;
          const id = e.target.dataset.id;
          const field = e.target.dataset.field;
          const doc = docs.find((d) => d.id === id);
          if (!doc) return;
          const v = parseNumber(e.target.value);
          if (field === "pages") doc.pages = Math.max(0, Math.floor(v));
          if (field === "pricePerPage") doc.pricePerPage = Math.max(0, v);

          // Clear previous timer
          if (inputDebounceTimer) clearTimeout(inputDebounceTimer);

          // Store the focused element and cursor position
          const focusedElement = document.activeElement;
          const cursorPos = focusedElement?.selectionStart || 0;

          // Debounce render to avoid losing focus while typing
          inputDebounceTimer = setTimeout(() => {
            render();
            // Restore focus if the field still exists
            if (focusedElement && focusedElement.parentElement) {
              focusedElement.focus();
              if (focusedElement.setSelectionRange) {
                focusedElement.setSelectionRange(cursorPos, cursorPos);
              }
            }
            inputDebounceTimer = null;
          }, 100);
        });

        // Handle clicks inside the docs table (remove button)
        $("tbody").addEventListener("click", (e) => {
          if (!(e.target instanceof HTMLElement)) return;
          const btn = e.target.closest("button");
          if (!btn) return;
          const action = btn.dataset.action;
          const id = btn.dataset.id;
          if (!action || !id) return;
          if (action === "remove") {
            docs = docs.filter((d) => d.id !== id);
            addedOrder = addedOrder.filter((x) => x !== id);
            render();
            flashInvoice();
            toast("Removed", "Document removed");
          }
        });

        // Apply a price to all documents
        $("applyPriceAllBtn").addEventListener("click", async () => {
          if (!docs || docs.length === 0) {
            toast("No documents", "Add documents first");
            return;
          }
          const result = await showInput(
            "Apply price to all",
            "Price (₱)",
            String(settings.basePricePerPage),
          );
          if (result === null) return;
          const n = parseNumber(result);
          if (!Number.isFinite(n) || n < 0) {
            toast("Invalid", "Enter a valid number");
            return;
          }
          docs.forEach((d) => (d.pricePerPage = n));
          render();
          flashInvoice();
          toast("Applied", `Price set to ${money(n)}`);
        });

        $("exportPngBtn").addEventListener("click", exportPng);
        $("copyImageBtn").addEventListener("click", copyAsImage);
        $("copyTextBtn").addEventListener("click", copyAsText);

        // Settings Modal
        $("settingsBtn").addEventListener("click", () => {
          updateSettingsUI();
          openModal("settingsModal");
        });

        $("closeSettings").addEventListener("click", () =>
          closeModal("settingsModal"),
        );
        $("closeSettingsBtn").addEventListener("click", () =>
          closeModal("settingsModal"),
        );

        // Settings Tabs
        document.querySelectorAll(".settings-tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            document
              .querySelectorAll(".settings-tab")
              .forEach((t) => t.classList.remove("active"));
            document
              .querySelectorAll(".settings-panel")
              .forEach((p) => p.classList.remove("active"));
            tab.classList.add("active");
            $(`panel-${tab.dataset.tab}`).classList.add("active");
          });
        });

        // Settings Inputs
        $("basePricePerPage").addEventListener("input", (e) => {
          settings.basePricePerPage = parseNumber(e.target.value);
          saveSettings();
        });

        $("vatPercent").addEventListener("input", (e) => {
          settings.vatPercent = parseNumber(e.target.value);
          saveSettings();
          render();
        });

        $("toggleRoundPeso").addEventListener("click", () => {
          settings.roundToPeso = !settings.roundToPeso;
          $("toggleRoundPeso").className = settings.roundToPeso
            ? "toggle active"
            : "toggle";
          saveSettings();
          render();
        });

        $("toggleColorRows").addEventListener("click", () => {
          settings.colorCodeRows = !settings.colorCodeRows;
          $("toggleColorRows").className = settings.colorCodeRows
            ? "toggle active"
            : "toggle";
          saveSettings();
          render();
        });

        // Tier Management
        $("addTierBtn").addEventListener("click", () => {
          settings.tiers.push({
            threshold: (settings.tiers.length + 1) * 10,
            discount: 5, // 5% discount by default
          });
          saveSettings();
          renderTiers();
        });

        $("tierList").addEventListener("input", (e) => {
          if (!(e.target instanceof HTMLInputElement)) return;
          const idx = parseInt(e.target.dataset.tier);
          const field = e.target.dataset.field;
          if (isNaN(idx) || !settings.tiers[idx]) return;
          settings.tiers[idx][field] = parseNumber(e.target.value);
          saveSettings();
        });

        $("tierList").addEventListener("click", (e) => {
          if (!(e.target instanceof HTMLElement)) return;
          if (e.target.classList.contains("tier-remove")) {
            const idx = parseInt(e.target.dataset.tier);
            if (!isNaN(idx)) {
              settings.tiers.splice(idx, 1);
              saveSettings();
              renderTiers();
            }
          }
        });

        // Analytics Modal
        $("analyticsBtn").addEventListener("click", () => {
          renderAnalytics();
          openModal("analyticsModal");
        });

        // Orders Modal
        $("ordersBtn").addEventListener("click", () => {
          loadOrders();
          renderOrders();
          openModal("ordersModal");
        });

        $("closeOrders").addEventListener("click", () =>
          closeModal("ordersModal"),
        );
        $("closeOrdersBtn").addEventListener("click", () =>
          closeModal("ordersModal"),
        );

        // Recent Documents Modal
        $("recentDocsBtn").addEventListener("click", () => {
          renderRecentDocuments();
          openModal("recentDocsModal");
        });

        $("closeRecentDocs").addEventListener("click", () =>
          closeModal("recentDocsModal"),
        );
        $("closeRecentDocsBtn").addEventListener("click", () =>
          closeModal("recentDocsModal"),
        );

        // Export / Place Order button (in Export Options)
        $("placeOrderExportBtn").addEventListener("click", () => {
          // Place order and automatically clear documents
          placeOrderFromCurrentInvoice({ clearAfter: true });
        });

        $("ordersList").addEventListener("click", async (e) => {
          if (!(e.target instanceof HTMLElement)) return;
          const btn = e.target.closest("button");
          if (!btn) return;
          const action = btn.dataset.action;
          const id = btn.dataset.id;
          if (!action || !id) return;
          if (action === "toggle") {
            toggleOrderDone(id);
          } else if (action === "delete") {
            const confirmed = await showConfirm(
              "Delete Order",
              "Delete this order?",
            );
            if (confirmed) deleteOrderById(id);
          } else if (action === "view") {
            viewOrderDetails(id);
          }
        });

        $("closeAnalytics").addEventListener("click", () =>
          closeModal("analyticsModal"),
        );
        $("closeAnalyticsBtn").addEventListener("click", () =>
          closeModal("analyticsModal"),
        );

        $("clearAnalyticsBtn").addEventListener("click", async () => {
          const confirmed = await showConfirm(
            "Clear Analytics",
            "This will permanently delete all analytics data. Continue?",
          );
          if (!confirmed) return;
          analytics = {
            totalRevenue: 0,
            totalPages: 0,
            invoicesCreated: 0,
            docsProcessed: 0,
            clients: {},
            topDocs: [],
          };
          saveAnalytics();
          renderAnalytics();
          toast("Cleared", "Analytics data deleted");
        });

        // Confirm Modal
        $("closeConfirm").addEventListener("click", () => {
          closeModal("confirmModal");
          if (confirmCallback) confirmCallback(false);
        });
        $("confirmCancel").addEventListener("click", () => {
          closeModal("confirmModal");
          if (confirmCallback) confirmCallback(false);
        });
        $("confirmOk").addEventListener("click", () => {
          closeModal("confirmModal");
          if (confirmCallback) confirmCallback(true);
        });

        // Input Modal
        $("closeInput").addEventListener("click", () => {
          closeModal("inputModal");
          if (inputCallback) inputCallback(null);
        });
        $("inputCancel").addEventListener("click", () => {
          closeModal("inputModal");
          if (inputCallback) inputCallback(null);
        });
        $("inputOk").addEventListener("click", () => {
          closeModal("inputModal");
          if (inputCallback) inputCallback($("inputValue").value);
        });
        $("inputValue").addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            closeModal("inputModal");
            if (inputCallback) inputCallback($("inputValue").value);
          }
        });

        // Close modals on overlay click
        document.querySelectorAll(".modal-overlay").forEach((overlay) => {
          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) {
              closeModal(overlay.id);
              if (overlay.id === "confirmModal" && confirmCallback)
                confirmCallback(false);
              if (overlay.id === "inputModal" && inputCallback)
                inputCallback(null);
            }
          });
        });
      }

      // ===== Boot =====
      function boot() {
        console.log("Boot function starting...");
        loadSettings();
        loadAnalytics();
        loadOrders();
        loadRecentClients();
        loadRecentDocuments();

        $("invoiceDate").value = todayISO();
        loadDraft();

        if (!currentInvoiceNumber) {
          currentInvoiceNumber = generateInvoiceNumber();
          invoiceCreatedTime = new Date().toISOString();
        }

        $("invoiceNumber").value = currentInvoiceNumber;

        // Apply default price to docs without price
        docs.forEach((d) => {
          if (!d.pricePerPage) d.pricePerPage = settings.basePricePerPage;
        });

        console.log("About to bind events...");
        bindEvents();
        console.log("Events bound successfully");
        render();

        const updateOnline = () =>
          setStatus(navigator.onLine ? "Ready" : "Offline", navigator.onLine);
        window.addEventListener("online", updateOnline);
        window.addEventListener("offline", updateOnline);
        updateOnline();
        console.log("Boot complete");
      }

      window.addEventListener("load", boot);
    </script>
  </body>
</html>
